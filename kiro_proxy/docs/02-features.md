# 功能特性

## 多协议支持

Kiro Proxy 支持三种主流 AI API 协议，可以适配不同的客户端：

| 协议 | 端点 | 适用客户端 |
|------|------|------------|
| OpenAI | `/v1/chat/completions` | Codex CLI, ChatGPT 客户端 |
| Anthropic | `/v1/messages` | Claude Code, Claude 客户端 |
| Gemini | `/v1/models/{model}:generateContent` | Gemini CLI |

代理会自动将请求转换为 Kiro API 格式，响应转换回对应协议格式。

---

## 多账号管理

### 账号轮询

支持添加多个 Kiro 账号，代理会自动轮询使用：

- 每个请求选择一个可用账号
- 自动跳过冷却中或不健康的账号
- 负载均衡，避免单账号压力过大

### 会话粘性

为了保持对话上下文的连贯性：

- 同一会话 ID 在 60 秒内会使用同一账号
- 超过 60 秒或账号不可用时才切换
- 通过请求头中的会话标识实现

### 账号状态

每个账号有四种状态：

| 状态 | 说明 | 颜色 |
|------|------|------|
| Active | 正常可用 | 绿色 |
| Cooldown | 触发限流，冷却中 | 黄色 |
| Unhealthy | 健康检查失败 | 红色 |
| Disabled | 手动禁用 | 灰色 |

---

## Token 自动刷新

### 自动检测

- 后台每 5 分钟检查所有账号的 Token 状态
- 检测 Token 是否即将过期（15 分钟内）

### 自动刷新

- 发现即将过期的 Token 自动刷新
- 支持 Social 认证（Google/GitHub）的 refresh_token
- 刷新失败会标记账号为不健康

### 手动刷新

- 在账号卡片点击「刷新 Token」
- 或点击「刷新所有 Token」批量刷新

---

## 配额管理

### 429 自动处理

当 Kiro API 返回 429 (Too Many Requests) 时：

1. 自动将该账号标记为 Cooldown 状态
2. 设置 5 分钟冷却时间
3. 立即切换到其他可用账号重试
4. 冷却结束后自动恢复

### 手动恢复

如果需要提前恢复账号：

1. 在「监控」页面查看配额状态
2. 点击账号旁的「恢复」按钮

---

## 流量监控

### 请求记录

记录所有经过代理的 LLM 请求：

- 请求时间、模型、账号
- 输入/输出 Token 数量
- 响应时间、状态码
- 完整的请求和响应内容

### 搜索过滤

- 按协议筛选（OpenAI/Anthropic/Gemini）
- 按状态筛选（完成/错误/进行中）
- 关键词搜索

### 导出功能

- 支持导出为 JSON 格式
- 可选择导出全部或指定记录

---

## 登录方式

### Google 登录

使用 Google 账号通过 OAuth 授权登录。

### GitHub 登录

使用 GitHub 账号通过 OAuth 授权登录。

### AWS Builder ID

使用 AWS Builder ID 通过 Device Code Flow 登录：

1. 点击 AWS 登录按钮
2. 复制显示的授权码
3. 在浏览器中打开授权页面
4. 输入授权码完成登录

---

## 配置持久化

### 自动保存

账号配置自动保存到 `~/.kiro-proxy/config.json`：

- 账号列表和状态
- 启用/禁用设置
- Token 文件路径

### 重启恢复

重启代理后自动加载保存的配置，无需重新添加账号。

### 导入导出

- 「导出配置」下载当前配置
- 「导入配置」从文件恢复
